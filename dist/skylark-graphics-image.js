/**
 * skylark-graphics-image - The skylark imagex utility library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
!function(e,r){var n=r.define,require=r.require,t="function"==typeof n&&n.amd,a=!t&&"undefined"!=typeof exports;if(!t&&!n){var o={};n=r.define=function(e,r,n){"function"==typeof n?(o[e]={factory:n,deps:r.map(function(r){return function(e,r){if("."!==e[0])return e;var n=r.split("/"),t=e.split("/");n.pop();for(var a=0;a<t.length;a++)"."!=t[a]&&(".."==t[a]?n.pop():n.push(t[a]));return n.join("/")}(r,e)}),resolved:!1,exports:null},require(e)):o[e]={factory:null,resolved:!0,exports:n}},require=r.require=function(e){if(!o.hasOwnProperty(e))throw new Error("Module "+e+" has not been defined");var module=o[e];if(!module.resolved){var n=[];module.deps.forEach(function(e){n.push(require(e))}),module.exports=module.factory.apply(r,n)||null,module.resolved=!0}return module.exports}}if(!n)throw new Error("The module utility (ex: requirejs or skylark-utils) is not loaded!");if(function(e,require){e("skylark-graphics-image/jpeg",["skylark-langx-ns"],function(e){"use strict";return e.attach("graphics.jpeg")}),e("skylark-graphics-image/jpeg-image",["skylark-langx-exceptions/base-exception","skylark-langx-binary","./jpeg"],function(e,r,n){"use strict";class t extends e{constructor(e){super(`JPEG error: ${e}`)}}class a extends e{constructor(e,r){super(e),this.scanLines=r}}class o extends e{}var i=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),s=4017,c=799,f=3406,l=2276,u=1567,h=3784,d=5793,m=2896;function p({decodeTransform:e=null,colorTransform:r=-1}={}){this._decodeTransform=e,this._colorTransform=r}function v(e,r){for(var n,t,a=0,o=[],i=16;i>0&&!e[i-1];)i--;o.push({children:[],index:0});var s,c=o[0];for(n=0;n<i;n++){for(t=0;t<e[n];t++){for((c=o.pop()).children[c.index]=r[a];c.index>0;)c=o.pop();for(c.index++,o.push(c);o.length<=n;)o.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s;a++}n+1<i&&(o.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s)}return o[0].children}function g(e,r,n){return 64*((e.blocksPerLine+1)*r+n)}function k(e,n,s,c,f,l,u,h,d,m=!1){var p=s.mcusPerLine,v=s.progressive;const k=n;let b=0,y=0;function x(){if(y>0)return b>>--y&1;if(255===(b=e[n++])){var i=e[n++];if(i){if(220===i&&m){n+=2;const t=r.readUint16(e,n);if(n+=2,t>0&&t!==s.scanLines)throw new a("Found DNL marker (0xFFDC) while parsing scan data",t)}else if(217===i){if(m){const e=I*(8===s.precision?8:0);if(e>0&&Math.round(s.scanLines/e)>=10)throw new a("Found EOI marker (0xFFD9) while parsing scan data, possibly caused by incorrect `scanLines` parameter",e)}throw new o("Found EOI marker (0xFFD9) while parsing scan data")}throw new t(`unexpected marker ${(b<<8|i).toString(16)}`)}}return y=7,b>>>7}function D(e){for(var r=e;;){switch(typeof(r=r[x()])){case"number":return r;case"object":continue}throw new t("invalid huffman sequence")}}function C(e){for(var r=0;e>0;)r=r<<1|x(),e--;return r}function T(e){if(1===e)return 1===x()?1:-1;var r=C(e);return r>=1<<e-1?r:r+(-1<<e)+1}var P=0;var L,U=0;let I=0;function j(e,r,n,t,a){var o=n/p|0,i=n%p;I=o*e.v+t;var s=i*e.h+a;const c=g(e,I,s);r(e,c)}function A(e,r,n){I=n/e.blocksPerLine|0;var t=n%e.blocksPerLine;const a=g(e,I,t);r(e,a)}var _,F,S,B,J,R,q=c.length;R=v?0===l?0===h?function(e,r){var n=D(e.huffmanTableDC),t=0===n?0:T(n)<<d;e.blockData[r]=e.pred+=t}:function(e,r){e.blockData[r]|=x()<<d}:0===h?function(e,r){if(P>0)return void P--;var n=l,t=u;for(;n<=t;){var a=D(e.huffmanTableAC),o=15&a,s=a>>4;if(0!==o){var c=i[n+=s];e.blockData[r+c]=T(o)*(1<<d),n++}else{if(s<15){P=C(s)+(1<<s)-1;break}n+=16}}}:function(e,r){var n,a,o=l,s=u,c=0;for(;o<=s;){const s=r+i[o],f=e.blockData[s]<0?-1:1;switch(U){case 0:if(a=D(e.huffmanTableAC),c=a>>4,0===(n=15&a))c<15?(P=C(c)+(1<<c),U=4):(c=16,U=1);else{if(1!==n)throw new t("invalid ACn encoding");L=T(n),U=c?2:3}continue;case 1:case 2:e.blockData[s]?e.blockData[s]+=f*(x()<<d):0===--c&&(U=2===U?3:0);break;case 3:e.blockData[s]?e.blockData[s]+=f*(x()<<d):(e.blockData[s]=L<<d,U=0);break;case 4:e.blockData[s]&&(e.blockData[s]+=f*(x()<<d))}o++}4===U&&0===--P&&(U=0)}:function(e,r){var n=D(e.huffmanTableDC),t=0===n?0:T(n);e.blockData[r]=e.pred+=t;var a=1;for(;a<64;){var o=D(e.huffmanTableAC),s=15&o,c=o>>4;if(0!==s){var f=i[a+=c];e.blockData[r+f]=T(s),a++}else{if(c<15)break;a+=16}}};var E,M,O,z,G=0;for(M=1===q?c[0].blocksPerLine*c[0].blocksPerColumn:p*s.mcusPerColumn;G<=M;){var Y=f?Math.min(M-G,f):M;if(Y>0){for(F=0;F<q;F++)c[F].pred=0;if(P=0,1===q)for(_=c[0],J=0;J<Y;J++)A(_,R,G),G++;else for(J=0;J<Y;J++){for(F=0;F<q;F++)for(_=c[F],O=_.h,z=_.v,S=0;S<z;S++)for(B=0;B<O;B++)j(_,R,G,S,B);G++}}if(y=0,!(E=w(e,n)))break;if(E.invalid){const e=Y>0?"unexpected":"excessive";sutil.warn(`decodeScan - ${e} MCU data, current marker is: ${E.invalid}`),n=E.offset}if(!(E.marker>=65488&&E.marker<=65495))break;n+=2}return n-k}function b(e,r,n){var a,o,i,p,v,g,k,b,y,w,x,D,C,T,P,L,U,I=e.quantizationTable,j=e.blockData;if(!I)throw new t("missing required Quantization Table.");for(var A=0;A<64;A+=8)y=j[r+A],w=j[r+A+1],x=j[r+A+2],D=j[r+A+3],C=j[r+A+4],T=j[r+A+5],P=j[r+A+6],L=j[r+A+7],y*=I[A],0!=(w|x|D|C|T|P|L)?(w*=I[A+1],x*=I[A+2],D*=I[A+3],C*=I[A+4],T*=I[A+5],P*=I[A+6],L*=I[A+7],o=(a=(a=d*y+128>>8)+(o=d*C+128>>8)+1>>1)-o,U=(i=x)*h+(p=P)*u+128>>8,i=i*u-p*h+128>>8,k=(v=(v=m*(w-L)+128>>8)+(k=T<<4)+1>>1)-k,g=(b=(b=m*(w+L)+128>>8)+(g=D<<4)+1>>1)-g,p=(a=a+(p=U)+1>>1)-p,i=(o=o+i+1>>1)-i,U=v*l+b*f+2048>>12,v=v*f-b*l+2048>>12,b=U,U=g*c+k*s+2048>>12,g=g*s-k*c+2048>>12,k=U,n[A]=a+b,n[A+7]=a-b,n[A+1]=o+k,n[A+6]=o-k,n[A+2]=i+g,n[A+5]=i-g,n[A+3]=p+v,n[A+4]=p-v):(U=d*y+512>>10,n[A]=U,n[A+1]=U,n[A+2]=U,n[A+3]=U,n[A+4]=U,n[A+5]=U,n[A+6]=U,n[A+7]=U);for(var _=0;_<8;++_)y=n[_],w=n[_+8],x=n[_+16],D=n[_+24],C=n[_+32],T=n[_+40],P=n[_+48],L=n[_+56],0!=(w|x|D|C|T|P|L)?(o=(a=4112+((a=d*y+2048>>12)+(o=d*C+2048>>12)+1>>1))-o,U=(i=x)*h+(p=P)*u+2048>>12,i=i*u-p*h+2048>>12,p=U,k=(v=(v=m*(w-L)+2048>>12)+(k=T)+1>>1)-k,g=(b=(b=m*(w+L)+2048>>12)+(g=D)+1>>1)-g,U=v*l+b*f+2048>>12,v=v*f-b*l+2048>>12,b=U,U=g*c+k*s+2048>>12,g=g*s-k*c+2048>>12,L=(a=a+p+1>>1)-b,w=(o=o+i+1>>1)+(k=U),P=o-k,x=(i=o-i)+g,T=i-g,D=(p=a-p)+v,C=p-v,(y=a+b)<16?y=0:y>=4080?y=255:y>>=4,w<16?w=0:w>=4080?w=255:w>>=4,x<16?x=0:x>=4080?x=255:x>>=4,D<16?D=0:D>=4080?D=255:D>>=4,C<16?C=0:C>=4080?C=255:C>>=4,T<16?T=0:T>=4080?T=255:T>>=4,P<16?P=0:P>=4080?P=255:P>>=4,L<16?L=0:L>=4080?L=255:L>>=4,j[r+_]=y,j[r+_+8]=w,j[r+_+16]=x,j[r+_+24]=D,j[r+_+32]=C,j[r+_+40]=T,j[r+_+48]=P,j[r+_+56]=L):(U=(U=d*y+8192>>14)<-2040?0:U>=2024?255:U+2056>>4,j[r+_]=U,j[r+_+8]=U,j[r+_+16]=U,j[r+_+24]=U,j[r+_+32]=U,j[r+_+40]=U,j[r+_+48]=U,j[r+_+56]=U)}function y(e,r){for(var n=r.blocksPerLine,t=r.blocksPerColumn,a=new Int16Array(64),o=0;o<t;o++)for(var i=0;i<n;i++){var s=g(r,o,i);b(r,s,a)}return r.blockData}function w(e,n,t=n){const a=e.length-1;var o=t<n?t:n;if(n>=a)return null;var i=r.readUint16(e,n);if(i>=65472&&i<=65534)return{invalid:null,marker:i,offset:n};for(var s=r.readUint16(e,o);!(s>=65472&&s<=65534);){if(++o>=a)return null;s=r.readUint16(e,o)}return{invalid:i.toString(16),marker:s,offset:o}}return p.prototype={parse(e,{dnlScanLines:n=null}={}){function s(){const n=r.readUint16(e,u);let t=(u+=2)+n-2;var a=w(e,t,u);a&&a.invalid&&(sutil.warn("readDataBlock - incorrect length, current marker is: "+a.invalid),t=a.offset);var o=e.subarray(u,t);return u+=o.length,o}function c(e){for(var r=Math.ceil(e.samplesPerLine/8/e.maxH),n=Math.ceil(e.scanLines/8/e.maxV),t=0;t<e.components.length;t++){z=e.components[t];var a=Math.ceil(Math.ceil(e.samplesPerLine/8)*z.h/e.maxH),o=Math.ceil(Math.ceil(e.scanLines/8)*z.v/e.maxV),i=r*z.h,s=n*z.v,c=64*s*(i+1);z.blockData=new Int16Array(c),z.blocksPerLine=a,z.blocksPerColumn=o}e.mcusPerLine=r,e.mcusPerColumn=n}var f,l,u=0,h=null,d=null;let m=0;var p=[],g=[],b=[];let x=r.readUint16(e,u);if(u+=2,65496!==x)throw new t("SOI not found");x=r.readUint16(e,u),u+=2;e:for(;65497!==x;){var D,C,T;switch(x){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var P=s();65504===x&&74===P[0]&&70===P[1]&&73===P[2]&&70===P[3]&&0===P[4]&&(h={version:{major:P[5],minor:P[6]},densityUnits:P[7],xDensity:P[8]<<8|P[9],yDensity:P[10]<<8|P[11],thumbWidth:P[12],thumbHeight:P[13],thumbData:P.subarray(14,14+3*P[12]*P[13])}),65518===x&&65===P[0]&&100===P[1]&&111===P[2]&&98===P[3]&&101===P[4]&&(d={version:P[5]<<8|P[6],flags0:P[7]<<8|P[8],flags1:P[9]<<8|P[10],transformCode:P[11]});break;case 65499:const y=r.readUint16(e,u);for(var L,U=y+(u+=2)-2;u<U;){var I=e[u++],j=new Uint16Array(64);if(I>>4==0)for(C=0;C<64;C++)L=i[C],j[L]=e[u++];else{if(I>>4!=1)throw new t("DQT - invalid table spec");for(C=0;C<64;C++)L=i[C],j[L]=r.readUint16(e,u),u+=2}p[15&I]=j}break;case 65472:case 65473:case 65474:if(f)throw new t("Only single frame JPEGs supported");u+=2,(f={}).extended=65473===x,f.progressive=65474===x,f.precision=e[u++];const X=r.readUint16(e,u);u+=2,f.scanLines=n||X,f.samplesPerLine=r.readUint16(e,u),u+=2,f.components=[],f.componentIds={};var A,_=e[u++],F=0,S=0;for(D=0;D<_;D++){A=e[u];var B=e[u+1]>>4,J=15&e[u+1];F<B&&(F=B),S<J&&(S=J);var R=e[u+2];T=f.components.push({h:B,v:J,quantizationId:R,quantizationTable:null}),f.componentIds[A]=T-1,u+=3}f.maxH=F,f.maxV=S,c(f);break;case 65476:const K=r.readUint16(e,u);for(u+=2,D=2;D<K;){var q=e[u++],E=new Uint8Array(16),M=0;for(C=0;C<16;C++,u++)M+=E[C]=e[u];var O=new Uint8Array(M);for(C=0;C<M;C++,u++)O[C]=e[u];D+=17+M,(q>>4==0?b:g)[15&q]=v(E,O)}break;case 65501:u+=2,l=r.readUint16(e,u),u+=2;break;case 65498:const Z=1==++m&&!n;u+=2;var z,G=e[u++],Y=[];for(D=0;D<G;D++){const r=e[u++];var N=f.componentIds[r];(z=f.components[N]).index=r;var H=e[u++];z.huffmanTableDC=b[H>>4],z.huffmanTableAC=g[15&H],Y.push(z)}var $=e[u++],V=e[u++],Q=e[u++];try{var W=k(e,u,f,Y,l,$,V,Q>>4,15&Q,Z);u+=W}catch(r){if(r instanceof a)return sutil.warn(`${r.message} -- attempting to re-parse the JPEG image.`),this.parse(e,{dnlScanLines:r.scanLines});if(r instanceof o){sutil.warn(`${r.message} -- ignoring the rest of the image data.`);break e}throw r}break;case 65500:u+=4;break;case 65535:255!==e[u]&&u--;break;default:const ee=w(e,u-2,u-3);if(ee&&ee.invalid){sutil.warn("JpegImage.parse - unexpected data, current marker is: "+ee.invalid),u=ee.offset;break}if(!ee||u>=e.length-1){sutil.warn("JpegImage.parse - reached the end of the image data without finding an EOI marker (0xFFD9).");break e}throw new t("JpegImage.parse - unknown marker: "+x.toString(16))}x=r.readUint16(e,u),u+=2}for(this.width=f.samplesPerLine,this.height=f.scanLines,this.jfif=h,this.adobe=d,this.components=[],D=0;D<f.components.length;D++){z=f.components[D];var X=p[z.quantizationId];X&&(z.quantizationTable=X),this.components.push({index:z.index,output:y(f,z),scaleX:z.h/f.maxH,scaleY:z.v/f.maxV,blocksPerLine:z.blocksPerLine,blocksPerColumn:z.blocksPerColumn})}this.numComponents=this.components.length},_getLinearizedBlockData(e,r,n=!1){var t,a,o,i,s,c,f,l,u,h,d,m=this.width/e,p=this.height/r,v=0,g=this.components.length,k=e*r*g,b=new Uint8ClampedArray(k),y=new Uint32Array(e);let w;for(f=0;f<g;f++){if(t=this.components[f],a=t.scaleX*m,o=t.scaleY*p,v=f,d=t.output,i=t.blocksPerLine+1<<3,a!==w){for(s=0;s<e;s++)l=0|s*a,y[s]=(4294967288&l)<<3|7&l;w=a}for(c=0;c<r;c++)for(h=i*(4294967288&(l=0|c*o))|(7&l)<<3,s=0;s<e;s++)b[v]=d[h+y[s]],v+=g}let x=this._decodeTransform;if(n||4!==g||x||(x=new Int32Array([-256,255,-256,255,-256,255,-256,255])),x)for(f=0;f<k;)for(l=0,u=0;l<g;l++,f++,u+=2)b[f]=(b[f]*x[u]>>8)+x[u+1];return b},get _isColorConversionNeeded(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this._colorTransform&&(82!==this.components[0].index||71!==this.components[1].index||66!==this.components[2].index):1===this._colorTransform},_convertYccToRgb:function(e){for(var r,n,t,a=0,o=e.length;a<o;a+=3)r=e[a],n=e[a+1],t=e[a+2],e[a]=r-179.456+1.402*t,e[a+1]=r+135.459-.344*n-.714*t,e[a+2]=r-226.816+1.772*n;return e},_convertYcckToRgb:function(e){for(var r,n,t,a,o=0,i=0,s=e.length;i<s;i+=4)r=e[i],n=e[i+1],t=e[i+2],a=e[i+3],e[o++]=n*(-660635669420364e-19*n+.000437130475926232*t-54080610064599e-18*r+.00048449797120281*a-.154362151871126)-122.67195406894+t*(-.000957964378445773*t+.000817076911346625*r-.00477271405408747*a+1.53380253221734)+r*(.000961250184130688*r-.00266257332283933*a+.48357088451265)+a*(-.000336197177618394*a+.484791561490776),e[o++]=107.268039397724+n*(219927104525741e-19*n-.000640992018297945*t+.000659397001245577*r+.000426105652938837*a-.176491792462875)+t*(-.000778269941513683*t+.00130872261408275*r+.000770482631801132*a-.151051492775562)+r*(.00126935368114843*r-.00265090189010898*a+.25802910206845)+a*(-.000318913117588328*a-.213742400323665),e[o++]=n*(-.000570115196973677*n-263409051004589e-19*t+.0020741088115012*r-.00288260236853442*a+.814272968359295)-20.810012546947+t*(-153496057440975e-19*t-.000132689043961446*r+.000560833691242812*a-.195152027534049)+r*(.00174418132927582*r-.00255243321439347*a+.116935020465145)+a*(-.000343531996510555*a+.24165260232407);return e.subarray(0,o)},_convertYcckToCmyk:function(e){for(var r,n,t,a=0,o=e.length;a<o;a+=4)r=e[a],n=e[a+1],t=e[a+2],e[a]=434.456-r-1.402*t,e[a+1]=119.541-r+.344*n+.714*t,e[a+2]=481.816-r-1.772*n;return e},_convertCmykToRgb:function(e){for(var r,n,t,a,o=0,i=0,s=e.length;i<s;i+=4)r=e[i],n=e[i+1],t=e[i+2],a=e[i+3],e[o++]=255+r*(-6747147073602441e-20*r+.0008379262121013727*n+.0002894718188643294*t+.003264231057537806*a-1.1185611867203937)+n*(26374107616089405e-21*n-8626949158638572e-20*t-.0002748769067499491*a-.02155688794978967)+t*(-3878099212869363e-20*t-.0003267808279485286*a+.0686742238595345)-a*(.0003361971776183937*a+.7430659151342254),e[o++]=255+r*(.00013596372813588848*r+.000924537132573585*n+.00010567359618683593*t+.0004791864687436512*a-.3109689587515875)+n*(-.00023545346108370344*n+.0002702845253534714*t+.0020200308977307156*a-.7488052167015494)+t*(6834815998235662e-20*t+.00015168452363460973*a-.09751927774728933)-a*(.0003189131175883281*a+.7364883807733168),e[o++]=255+r*(13598650411385307e-21*r+.00012423956175490851*n+.0004751985097583589*t-36729317476630422e-22*a-.05562186980264034)+n*(.00016141380598724676*n+.0009692239130725186*t+.0007782692450036253*a-.44015232367526463)+t*(5.068882914068769e-7*t+.0017778369011375071*a-.7591454649749609)-a*(.0003435319965105553*a+.7063770186160144);return e.subarray(0,o)},getData({width:e,height:r,forceRGB:n=!1,isSourcePDF:a=!1}){if(("undefined"==typeof PDFJSDev||PDFJSDev.test("!PRODUCTION || TESTING"))&&sutil.assert(!0===a,'JpegImage.getData: Unexpected "isSourcePDF" value for PDF files.'),this.numComponents>4)throw new t("Unsupported color mode");var o=this._getLinearizedBlockData(e,r,a);if(1===this.numComponents&&n){for(var i=o.length,s=new Uint8ClampedArray(3*i),c=0,f=0;f<i;f++){var l=o[f];s[c++]=l,s[c++]=l,s[c++]=l}return s}if(3===this.numComponents&&this._isColorConversionNeeded)return this._convertYccToRgb(o);if(4===this.numComponents){if(this._isColorConversionNeeded)return n?this._convertYcckToRgb(o):this._convertYcckToCmyk(o);if(n)return this._convertCmykToRgb(o)}return o}},n.JpegImage=p}),e("skylark-graphics-image/jpeg-stream",["skylark-langx-objects/shadow","skylark-io-streams/decode-stream","./jpeg","./jpeg-image"],function(e,r,n,t){"use strict";function a(e,n,t,a){let o;for(;-1!==(o=e.getByte());)if(255===o){e.skip(-1);break}this.stream=e,this.maybeLength=n,this.dict=t,this.params=a,r.call(this,n)}return a.prototype=Object.create(r.prototype),Object.defineProperty(a.prototype,"bytes",{get:function(){return e(this,"bytes",this.stream.getBytes(this.maybeLength))},configurable:!0}),a.prototype.ensureBuffer=function(e){},a.prototype.readBlock=function(){if(this.eof)return;const e={decodeTransform:void 0,colorTransform:void 0},r=this.dict.getArray("Decode","D");if(this.forceRGB&&Array.isArray(r)){const n=this.dict.get("BitsPerComponent")||8,t=r.length,a=new Int32Array(t);let o=!1;const i=(1<<n)-1;for(let e=0;e<t;e+=2)a[e]=256*(r[e+1]-r[e])|0,a[e+1]=r[e]*i|0,256===a[e]&&0===a[e+1]||(o=!0);o&&(e.decodeTransform=a)}if(this.params&&this.params.get){const r=this.params.get("ColorTransform");Number.isInteger(r)&&(e.colorTransform=r)}const n=new t(e);n.parse(this.bytes);const a=n.getData({width:this.drawWidth,height:this.drawHeight,forceRGB:this.forceRGB,isSourcePDF:!0});this.buffer=a,this.bufferLength=a.length,this.eof=!0},n.JpegStream=a}),e("skylark-graphics-image/main",["./jpeg","./jpeg-image","./jpeg-stream"],function(e){return e}),e("skylark-graphics-image",["skylark-graphics-image/main"],function(e){return e})}(n),!t){var i=require("skylark-langx-ns");a?module.exports=i:r.skylarkjs=i}}(0,this);
//# sourceMappingURL=sourcemaps/skylark-graphics-image.js.map
