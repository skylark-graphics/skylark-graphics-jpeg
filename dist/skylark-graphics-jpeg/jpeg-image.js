/**
 * skylark-graphics-jpeg - The skylark jpegx utility library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-exceptions/base-exception","skylark-langx-binary","skylark-langx-logging","skylark-langx-debugs","./jpeg"],function(e,n,r,a,t){"use strict";class o extends e{constructor(e){super(`JPEG error: ${e}`)}}class i extends e{constructor(e,n){super(e),this.scanLines=n}}class s extends e{}var c=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),l=4017,f=799,u=3406,h=2276,d=1567,m=3784,v=5793,p=2896;function b({decodeTransform:e=null,colorTransform:n=-1}={}){this._decodeTransform=e,this._colorTransform=n}function k(e,n){for(var r,a,t=0,o=[],i=16;i>0&&!e[i-1];)i--;o.push({children:[],index:0});var s,c=o[0];for(r=0;r<i;r++){for(a=0;a<e[r];a++){for((c=o.pop()).children[c.index]=n[t];c.index>0;)c=o.pop();for(c.index++,o.push(c);o.length<=r;)o.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s;t++}r+1<i&&(o.push(s={children:[],index:0}),c.children[c.index]=s.children,c=s)}return o[0].children}function g(e,n,r){return 64*((e.blocksPerLine+1)*n+r)}function w(e,a,t,l,f,u,h,d,m,v=!1){var p=t.mcusPerLine,b=t.progressive;const k=a;let w=0,x=0;function D(){if(x>0)return w>>--x&1;if(255===(w=e[a++])){var r=e[a++];if(r){if(220===r&&v){a+=2;const r=n.readUint16(e,a);if(a+=2,r>0&&r!==t.scanLines)throw new i("Found DNL marker (0xFFDC) while parsing scan data",r)}else if(217===r){if(v){const e=_*(8===t.precision?8:0);if(e>0&&Math.round(t.scanLines/e)>=10)throw new i("Found EOI marker (0xFFD9) while parsing scan data, possibly caused by incorrect `scanLines` parameter",e)}throw new s("Found EOI marker (0xFFD9) while parsing scan data")}throw new o(`unexpected marker ${(w<<8|r).toString(16)}`)}}return x=7,w>>>7}function y(e){for(var n=e;;){switch(typeof(n=n[D()])){case"number":return n;case"object":continue}throw new o("invalid huffman sequence")}}function P(e){for(var n=0;e>0;)n=n<<1|D(),e--;return n}function T(e){if(1===e)return 1===D()?1:-1;var n=P(e);return n>=1<<e-1?n:n+(-1<<e)+1}var L=0;var U,I=0;let _=0;function F(e,n,r,a,t){var o=r%p;_=(r/p|0)*e.v+a;var i=o*e.h+t;n(e,g(e,_,i))}function A(e,n,r){_=r/e.blocksPerLine|0;var a=r%e.blocksPerLine;n(e,g(e,_,a))}var S,J,M,z,R,Y,q=l.length;Y=b?0===u?0===d?function(e,n){var r=y(e.huffmanTableDC),a=0===r?0:T(r)<<m;e.blockData[n]=e.pred+=a}:function(e,n){e.blockData[n]|=D()<<m}:0===d?function(e,n){if(L>0)L--;else for(var r=u,a=h;r<=a;){var t=y(e.huffmanTableAC),o=15&t,i=t>>4;if(0!==o){var s=c[r+=i];e.blockData[n+s]=T(o)*(1<<m),r++}else{if(i<15){L=P(i)+(1<<i)-1;break}r+=16}}}:function(e,n){for(var r,a,t=u,i=h,s=0;t<=i;){const i=n+c[t],l=e.blockData[i]<0?-1:1;switch(I){case 0:if(s=(a=y(e.huffmanTableAC))>>4,0==(r=15&a))s<15?(L=P(s)+(1<<s),I=4):(s=16,I=1);else{if(1!==r)throw new o("invalid ACn encoding");U=T(r),I=s?2:3}continue;case 1:case 2:e.blockData[i]?e.blockData[i]+=l*(D()<<m):0==--s&&(I=2===I?3:0);break;case 3:e.blockData[i]?e.blockData[i]+=l*(D()<<m):(e.blockData[i]=U<<m,I=0);break;case 4:e.blockData[i]&&(e.blockData[i]+=l*(D()<<m))}t++}4===I&&0==--L&&(I=0)}:function(e,n){var r=y(e.huffmanTableDC),a=0===r?0:T(r);e.blockData[n]=e.pred+=a;for(var t=1;t<64;){var o=y(e.huffmanTableAC),i=15&o,s=o>>4;if(0!==i){var l=c[t+=s];e.blockData[n+l]=T(i),t++}else{if(s<15)break;t+=16}}};var E,O,N,$,G=0;for(O=1===q?l[0].blocksPerLine*l[0].blocksPerColumn:p*t.mcusPerColumn;G<=O;){var H=f?Math.min(O-G,f):O;if(H>0){for(J=0;J<q;J++)l[J].pred=0;if(L=0,1===q)for(S=l[0],R=0;R<H;R++)A(S,Y,G),G++;else for(R=0;R<H;R++){for(J=0;J<q;J++)for(N=(S=l[J]).h,$=S.v,M=0;M<$;M++)for(z=0;z<N;z++)F(S,Y,G,M,z);G++}}if(x=0,!(E=C(e,a)))break;if(E.invalid){const e=H>0?"unexpected":"excessive";r.warn(`decodeScan - ${e} MCU data, current marker is: ${E.invalid}`),a=E.offset}if(!(E.marker>=65488&&E.marker<=65495))break;a+=2}return a-k}function x(e,n,r){var a,t,i,s,c,b,k,g,w,x,D,C,y,P,T,L,U,I=e.quantizationTable,_=e.blockData;if(!I)throw new o("missing required Quantization Table.");for(var F=0;F<64;F+=8)w=_[n+F],x=_[n+F+1],D=_[n+F+2],C=_[n+F+3],y=_[n+F+4],P=_[n+F+5],T=_[n+F+6],L=_[n+F+7],w*=I[F],0!=(x|D|C|y|P|T|L)?(x*=I[F+1],D*=I[F+2],C*=I[F+3],y*=I[F+4],P*=I[F+5],T*=I[F+6],L*=I[F+7],t=(a=(a=v*w+128>>8)+(t=v*y+128>>8)+1>>1)-t,U=(i=D)*m+(s=T)*d+128>>8,i=i*d-s*m+128>>8,k=(c=(c=p*(x-L)+128>>8)+(k=P<<4)+1>>1)-k,b=(g=(g=p*(x+L)+128>>8)+(b=C<<4)+1>>1)-b,s=(a=a+(s=U)+1>>1)-s,i=(t=t+i+1>>1)-i,U=c*h+g*u+2048>>12,c=c*u-g*h+2048>>12,g=U,U=b*f+k*l+2048>>12,b=b*l-k*f+2048>>12,k=U,r[F]=a+g,r[F+7]=a-g,r[F+1]=t+k,r[F+6]=t-k,r[F+2]=i+b,r[F+5]=i-b,r[F+3]=s+c,r[F+4]=s-c):(U=v*w+512>>10,r[F]=U,r[F+1]=U,r[F+2]=U,r[F+3]=U,r[F+4]=U,r[F+5]=U,r[F+6]=U,r[F+7]=U);for(var A=0;A<8;++A)w=r[A],0!=((x=r[A+8])|(D=r[A+16])|(C=r[A+24])|(y=r[A+32])|(P=r[A+40])|(T=r[A+48])|(L=r[A+56]))?(t=(a=4112+((a=v*w+2048>>12)+(t=v*y+2048>>12)+1>>1))-t,U=(i=D)*m+(s=T)*d+2048>>12,i=i*d-s*m+2048>>12,s=U,k=(c=(c=p*(x-L)+2048>>12)+(k=P)+1>>1)-k,b=(g=(g=p*(x+L)+2048>>12)+(b=C)+1>>1)-b,U=c*h+g*u+2048>>12,c=c*u-g*h+2048>>12,g=U,U=b*f+k*l+2048>>12,b=b*l-k*f+2048>>12,L=(a=a+s+1>>1)-g,x=(t=t+i+1>>1)+(k=U),T=t-k,D=(i=t-i)+b,P=i-b,C=(s=a-s)+c,y=s-c,(w=a+g)<16?w=0:w>=4080?w=255:w>>=4,x<16?x=0:x>=4080?x=255:x>>=4,D<16?D=0:D>=4080?D=255:D>>=4,C<16?C=0:C>=4080?C=255:C>>=4,y<16?y=0:y>=4080?y=255:y>>=4,P<16?P=0:P>=4080?P=255:P>>=4,T<16?T=0:T>=4080?T=255:T>>=4,L<16?L=0:L>=4080?L=255:L>>=4,_[n+A]=w,_[n+A+8]=x,_[n+A+16]=D,_[n+A+24]=C,_[n+A+32]=y,_[n+A+40]=P,_[n+A+48]=T,_[n+A+56]=L):(U=(U=v*w+8192>>14)<-2040?0:U>=2024?255:U+2056>>4,_[n+A]=U,_[n+A+8]=U,_[n+A+16]=U,_[n+A+24]=U,_[n+A+32]=U,_[n+A+40]=U,_[n+A+48]=U,_[n+A+56]=U)}function D(e,n){for(var r=n.blocksPerLine,a=n.blocksPerColumn,t=new Int16Array(64),o=0;o<a;o++)for(var i=0;i<r;i++){x(n,g(n,o,i),t)}return n.blockData}function C(e,r,a=r){const t=e.length-1;var o=a<r?a:r;if(r>=t)return null;var i=n.readUint16(e,r);if(i>=65472&&i<=65534)return{invalid:null,marker:i,offset:r};for(var s=n.readUint16(e,o);!(s>=65472&&s<=65534);){if(++o>=t)return null;s=n.readUint16(e,o)}return{invalid:i.toString(16),marker:s,offset:o}}return b.prototype={parse(e,{dnlScanLines:a=null}={}){function t(){const a=n.readUint16(e,h);let t=(h+=2)+a-2;var o=C(e,t,h);o&&o.invalid&&(r.warn("readDataBlock - incorrect length, current marker is: "+o.invalid),t=o.offset);var i=e.subarray(h,t);return h+=i.length,i}function l(e){for(var n=Math.ceil(e.samplesPerLine/8/e.maxH),r=Math.ceil(e.scanLines/8/e.maxV),a=0;a<e.components.length;a++){N=e.components[a];var t=Math.ceil(Math.ceil(e.samplesPerLine/8)*N.h/e.maxH),o=Math.ceil(Math.ceil(e.scanLines/8)*N.v/e.maxV),i=n*N.h,s=64*(r*N.v)*(i+1);N.blockData=new Int16Array(s),N.blocksPerLine=t,N.blocksPerColumn=o}e.mcusPerLine=n,e.mcusPerColumn=r}var f,u,h=0,d=null,m=null;let v=0;var p=[],b=[],g=[];let x=n.readUint16(e,h);if(h+=2,65496!==x)throw new o("SOI not found");x=n.readUint16(e,h),h+=2;e:for(;65497!==x;){var y,P,T;switch(x){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var L=t();65504===x&&74===L[0]&&70===L[1]&&73===L[2]&&70===L[3]&&0===L[4]&&(d={version:{major:L[5],minor:L[6]},densityUnits:L[7],xDensity:L[8]<<8|L[9],yDensity:L[10]<<8|L[11],thumbWidth:L[12],thumbHeight:L[13],thumbData:L.subarray(14,14+3*L[12]*L[13])}),65518===x&&65===L[0]&&100===L[1]&&111===L[2]&&98===L[3]&&101===L[4]&&(m={version:L[5]<<8|L[6],flags0:L[7]<<8|L[8],flags1:L[9]<<8|L[10],transformCode:L[11]});break;case 65499:for(var U=n.readUint16(e,h)+(h+=2)-2;h<U;){var I=e[h++],_=new Uint16Array(64);if(I>>4==0)for(P=0;P<64;P++)_[c[P]]=e[h++];else{if(I>>4!=1)throw new o("DQT - invalid table spec");for(P=0;P<64;P++)_[c[P]]=n.readUint16(e,h),h+=2}p[15&I]=_}break;case 65472:case 65473:case 65474:if(f)throw new o("Only single frame JPEGs supported");h+=2,(f={}).extended=65473===x,f.progressive=65474===x,f.precision=e[h++];const D=n.readUint16(e,h);h+=2,f.scanLines=a||D,f.samplesPerLine=n.readUint16(e,h),h+=2,f.components=[],f.componentIds={};var F,A=e[h++],S=0,J=0;for(y=0;y<A;y++){F=e[h];var M=e[h+1]>>4,z=15&e[h+1];S<M&&(S=M),J<z&&(J=z);var R=e[h+2];T=f.components.push({h:M,v:z,quantizationId:R,quantizationTable:null}),f.componentIds[F]=T-1,h+=3}f.maxH=S,f.maxV=J,l(f);break;case 65476:const W=n.readUint16(e,h);for(h+=2,y=2;y<W;){var Y=e[h++],q=new Uint8Array(16),E=0;for(P=0;P<16;P++,h++)E+=q[P]=e[h];var O=new Uint8Array(E);for(P=0;P<E;P++,h++)O[P]=e[h];y+=17+E,(Y>>4==0?g:b)[15&Y]=k(q,O)}break;case 65501:h+=2,u=n.readUint16(e,h),h+=2;break;case 65498:const K=1==++v&&!a;h+=2;var N,$=e[h++],G=[];for(y=0;y<$;y++){const n=e[h++];var H=f.componentIds[n];(N=f.components[H]).index=n;var j=e[h++];N.huffmanTableDC=g[j>>4],N.huffmanTableAC=b[15&j],G.push(N)}var B=e[h++],V=e[h++],Q=e[h++];try{var X=w(e,h,f,G,u,B,V,Q>>4,15&Q,K);h+=X}catch(n){if(n instanceof i)return r.warn(`${n.message} -- attempting to re-parse the JPEG image.`),this.parse(e,{dnlScanLines:n.scanLines});if(n instanceof s){r.warn(`${n.message} -- ignoring the rest of the image data.`);break e}throw n}break;case 65500:h+=4;break;case 65535:255!==e[h]&&h--;break;default:const Z=C(e,h-2,h-3);if(Z&&Z.invalid){r.warn("JpegImage.parse - unexpected data, current marker is: "+Z.invalid),h=Z.offset;break}if(!Z||h>=e.length-1){r.warn("JpegImage.parse - reached the end of the image data without finding an EOI marker (0xFFD9).");break e}throw new o("JpegImage.parse - unknown marker: "+x.toString(16))}x=n.readUint16(e,h),h+=2}for(this.width=f.samplesPerLine,this.height=f.scanLines,this.jfif=d,this.adobe=m,this.components=[],y=0;y<f.components.length;y++){var W=p[(N=f.components[y]).quantizationId];W&&(N.quantizationTable=W),this.components.push({index:N.index,output:D(0,N),scaleX:N.h/f.maxH,scaleY:N.v/f.maxV,blocksPerLine:N.blocksPerLine,blocksPerColumn:N.blocksPerColumn})}this.numComponents=this.components.length},_getLinearizedBlockData(e,n,r=!1){var a,t,o,i,s,c,l,f,u,h,d,m=this.width/e,v=this.height/n,p=0,b=this.components.length,k=e*n*b,g=new Uint8ClampedArray(k),w=new Uint32Array(e);let x;for(l=0;l<b;l++){if(t=(a=this.components[l]).scaleX*m,o=a.scaleY*v,p=l,d=a.output,i=a.blocksPerLine+1<<3,t!==x){for(s=0;s<e;s++)f=0|s*t,w[s]=(4294967288&f)<<3|7&f;x=t}for(c=0;c<n;c++)for(h=i*(4294967288&(f=0|c*o))|(7&f)<<3,s=0;s<e;s++)g[p]=d[h+w[s]],p+=b}let D=this._decodeTransform;if(r||4!==b||D||(D=new Int32Array([-256,255,-256,255,-256,255,-256,255])),D)for(l=0;l<k;)for(f=0,u=0;f<b;f++,l++,u+=2)g[l]=(g[l]*D[u]>>8)+D[u+1];return g},get _isColorConversionNeeded(){return this.adobe?!!this.adobe.transformCode:3===this.numComponents?0!==this._colorTransform&&(82!==this.components[0].index||71!==this.components[1].index||66!==this.components[2].index):1===this._colorTransform},_convertYccToRgb:function(e){for(var n,r,a,t=0,o=e.length;t<o;t+=3)n=e[t],r=e[t+1],a=e[t+2],e[t]=n-179.456+1.402*a,e[t+1]=n+135.459-.344*r-.714*a,e[t+2]=n-226.816+1.772*r;return e},_convertYcckToRgb:function(e){for(var n,r,a,t,o=0,i=0,s=e.length;i<s;i+=4)n=e[i],r=e[i+1],a=e[i+2],t=e[i+3],e[o++]=r*(-660635669420364e-19*r+.000437130475926232*a-54080610064599e-18*n+.00048449797120281*t-.154362151871126)-122.67195406894+a*(-.000957964378445773*a+.000817076911346625*n-.00477271405408747*t+1.53380253221734)+n*(.000961250184130688*n-.00266257332283933*t+.48357088451265)+t*(-.000336197177618394*t+.484791561490776),e[o++]=107.268039397724+r*(219927104525741e-19*r-.000640992018297945*a+.000659397001245577*n+.000426105652938837*t-.176491792462875)+a*(-.000778269941513683*a+.00130872261408275*n+.000770482631801132*t-.151051492775562)+n*(.00126935368114843*n-.00265090189010898*t+.25802910206845)+t*(-.000318913117588328*t-.213742400323665),e[o++]=r*(-.000570115196973677*r-263409051004589e-19*a+.0020741088115012*n-.00288260236853442*t+.814272968359295)-20.810012546947+a*(-153496057440975e-19*a-.000132689043961446*n+.000560833691242812*t-.195152027534049)+n*(.00174418132927582*n-.00255243321439347*t+.116935020465145)+t*(-.000343531996510555*t+.24165260232407);return e.subarray(0,o)},_convertYcckToCmyk:function(e){for(var n,r,a,t=0,o=e.length;t<o;t+=4)n=e[t],r=e[t+1],a=e[t+2],e[t]=434.456-n-1.402*a,e[t+1]=119.541-n+.344*r+.714*a,e[t+2]=481.816-n-1.772*r;return e},_convertCmykToRgb:function(e){for(var n,r,a,t,o=0,i=0,s=e.length;i<s;i+=4)n=e[i],r=e[i+1],a=e[i+2],t=e[i+3],e[o++]=255+n*(-6747147073602441e-20*n+.0008379262121013727*r+.0002894718188643294*a+.003264231057537806*t-1.1185611867203937)+r*(26374107616089405e-21*r-8626949158638572e-20*a-.0002748769067499491*t-.02155688794978967)+a*(-3878099212869363e-20*a-.0003267808279485286*t+.0686742238595345)-t*(.0003361971776183937*t+.7430659151342254),e[o++]=255+n*(.00013596372813588848*n+.000924537132573585*r+.00010567359618683593*a+.0004791864687436512*t-.3109689587515875)+r*(-.00023545346108370344*r+.0002702845253534714*a+.0020200308977307156*t-.7488052167015494)+a*(6834815998235662e-20*a+.00015168452363460973*t-.09751927774728933)-t*(.0003189131175883281*t+.7364883807733168),e[o++]=255+n*(13598650411385307e-21*n+.00012423956175490851*r+.0004751985097583589*a-36729317476630422e-22*t-.05562186980264034)+r*(.00016141380598724676*r+.0009692239130725186*a+.0007782692450036253*t-.44015232367526463)+a*(5.068882914068769e-7*a+.0017778369011375071*t-.7591454649749609)-t*(.0003435319965105553*t+.7063770186160144);return e.subarray(0,o)},getData({width:e,height:n,forceRGB:r=!1,isSourcePDF:t=!1}){if(("undefined"==typeof PDFJSDev||PDFJSDev.test("!PRODUCTION || TESTING"))&&a.assert(!0===t,'JpegImage.getData: Unexpected "isSourcePDF" value for PDF files.'),this.numComponents>4)throw new o("Unsupported color mode");var i=this._getLinearizedBlockData(e,n,t);if(1===this.numComponents&&r){for(var s=i.length,c=new Uint8ClampedArray(3*s),l=0,f=0;f<s;f++){var u=i[f];c[l++]=u,c[l++]=u,c[l++]=u}return c}if(3===this.numComponents&&this._isColorConversionNeeded)return this._convertYccToRgb(i);if(4===this.numComponents){if(this._isColorConversionNeeded)return r?this._convertYcckToRgb(i):this._convertYcckToCmyk(i);if(r)return this._convertCmykToRgb(i)}return i}},t.JpegImage=b});
//# sourceMappingURL=sourcemaps/jpeg-image.js.map
